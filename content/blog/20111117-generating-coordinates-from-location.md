title: Generating coordinates from location (Wordpress)
link: http://jaffamonkey.com/6210/generating-coordinates-from-location
author: jaffamonkey
description: 
post_id: 6210
created: 2011/11/17 18:00:13
created_gmt: 2011/11/17 18:00:13
comment_status: open
post_name: generating-coordinates-from-location
status: publish
post_type: post

# Generating coordinates from location (Wordpress)

Though you can manually add in post meta values for coordinates, or use plugins such as geopress or geo-mashup, it is not that complicated to automatically generate these yourself, using mathematics to work out coordinates. First of all, lets create the file that will do that work of generating coordinates (save as class.googleHelper.php, and save somewhere) <?php class googleHelper { /** * The Google Maps API key holder * @var string  */ private $mapApiKey; /** * Class Constructor * @param string $mapApiKey A Google Maps API Key (you can get one from http://code.google.com/apis/maps/signup.html) */ public function __construct($mapApiKey = '') { if ($mapApiKey){ $this->mapApiKey; } else { throw new Exception(__CLASS__ . ' error : You must set your API key before using this class!'); } } /** * Reads an URL to a string * @param string $url The URL to read from * @return string The URL content */ private function getURL($url){ $ch = curl_init(); curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE); curl_setopt($ch, CURLOPT_HEADER, 0); /** curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1); **/ curl_setopt($ch, CURLOPT_URL, $url); $tmp = curl_exec($ch); curl_close($ch); if ($tmp != false){ return $tmp; } } /** * Get Latitude/Longitude/Altitude based on an address * @param string $address The address for converting into coordinates * @return array An array containing Latitude/Longitude/Altitude data */ public function getCoordinates($address){ $address = str_replace(' ','+',$address); $url = 'http://maps.google.com/maps/geo?q=UK+' . $address . '&output=xml&key=' . $this->mapApiKey; $data = $this->getURL($url); if ($data){ $xml = new SimpleXMLElement($data); $requestCode = $xml->Response->Status->code; if ($requestCode == 200){ //all is ok $coords = $xml->Response->Placemark->Point->coordinates; $coords = explode(',',$coords); if (count($coords) > 1){ if (count($coords) == 3){ return array('lat' => $coords[1], 'lng' => $coords[0]); } else { return array('lat' => $coords[1], 'lng' => $coords[0]); } return $coords; } } } //return default data return array('lat' => 0, 'lng' => 0); } }; //end class ?> This is the code you need to enter into the post create/update process. Add this to custom functions.php which is usually within your theme file (if not, create one).  In your custom post form, you need to have some kind of locator value (I have assumed zipcode in this example). function add_post_meta($post_id, $meta_key, $meta_value, $unique = false) { require_once(TEMPLATEPATH . '/includes/coords/class.googleHelper.php'); // make sure meta is added to the post, not a revision if ( $the_post = wp_is_post_revision($post_id) ) $post_id = $the_post; return add_metadata('post', $post_id, $meta_key, $meta_value, $unique); $apiKey = 'ABQIAAAATtc8MGqCDWDWVpL0tG4FQRRXIb9jHthPfa3xnuqFkLGRdbMKLBT8gtEYIFp9gry7mVD8F9nev7uMvw'; $obj = new googleHelper($apiKey); $address = get_post_meta($post->ID, 'zipcode', true); $coords = $obj->getCoordinates($address); add_post_meta($post_id, 'cp_latitude', $coords['lat'], true);  add_post_meta($post_id, 'cp_longitude', $coords['lng'], true); }